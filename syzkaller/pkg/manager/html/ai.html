{{/*
Copyright 2024 syzkaller project authors. All rights reserved.
Use of this source code is governed by Apache 2 LICENSE that can be found in the LICENSE file.
PROBE: AI-guided fuzzing dashboard page (Phase 3).
*/}}

<table class="list_table">
<caption>AI Status:</caption>
<tr><td class="title">Model</td><td>{{.Model}} ({{.Provider}})</td></tr>
<tr><td class="title">Status</td><td><span id="ai-status">{{.Status}}</span>{{if .NextBatchSec}} | Next batch: <span id="countdown"></span>{{end}}</td></tr>
<tr><td class="title">Today</td><td>{{.TodayCalls}} calls, {{.TodayTokens}} tokens, ${{printf "%.2f" .TodayCostUSD}} (~{{.TodayCostKRW}} KRW)</td></tr>
<tr><td class="title">Total</td><td>{{.TotalCalls}} calls, {{.TotalTokens}} tokens, ${{printf "%.2f" .TotalCostUSD}} (~{{.TotalCostKRW}} KRW)</td></tr>
</table>

{{if not .Disabled}}
<br>
<table class="list_table" style="width:auto">
<caption>Actions:</caption>
<tr>
	<td class="title" style="vertical-align:top">Crash Analysis</td>
	<td>
		<button id="analyzeBtn" onclick="triggerAI('analyze')">Analyze Now</button>
		<span style="color:#888; font-size:12px; margin-left:6px">LLM analyzes each crash report and scores exploitability (0-100)</span>
	</td>
</tr>
<tr>
	<td class="title" style="vertical-align:top">Fuzzing Strategy</td>
	<td>
		<button id="stratBtn" onclick="triggerAI('strategize')">Strategize Now</button>
		<span style="color:#888; font-size:12px; margin-left:6px">LLM reviews coverage data and recommends syscall weights, seeds, focus targets</span>
	</td>
</tr>
</table>

<br>
<b>Console</b>
<div id="console" style="background:#1e1e1e; color:#d4d4d4; font-family:'Consolas','Courier New',monospace; font-size:12px; padding:10px; height:200px; overflow-y:auto; border:1px solid #555; border-radius:4px; margin-bottom:16px; white-space:pre-wrap;">Waiting for AI activity...
</div>

{{if .Crashes}}
<table class="list_table">
<caption>Crash Exploitability ({{.AnalyzedCount}} analyzed, {{.PendingCount}} pending):</caption>
<thead><tr>
	<th><a onclick="return sortTable(this, 'Title', textSort)" href="#">Title</a></th>
	<th><a onclick="return sortTable(this, 'Score', numSort)" href="#">Score</a></th>
	<th><a onclick="return sortTable(this, 'Class', textSort)" href="#">Class</a></th>
	<th><a onclick="return sortTable(this, 'Vuln', textSort)" href="#">Vuln</a></th>
	<th><a onclick="return sortTable(this, 'Time', textSort)" href="#">Time</a></th>
</tr></thead>
<tbody>
{{range $c := .Crashes}}
<tr>
	<td class="title"><a href="/crash?id={{$c.ID}}">{{$c.Title}}</a></td>
	<td class="stat" {{if $c.ScoreColor}}style="background:{{$c.ScoreColor}}"{{end}}>{{if $c.HasScore}}<a href="/ai/crash?id={{$c.ID}}" style="font-weight:bold; color:inherit; text-decoration:none">{{$c.Score}}</a>{{else}}-{{end}}</td>
	<td>{{$c.ExploitClass}}</td>
	<td>{{$c.VulnType}}</td>
	<td class="time">{{if $c.HasScore}}{{formatTime $c.AnalyzedAt}}{{else}}<span style="color:#999">pending</span>{{end}}</td>
</tr>
{{end}}
</tbody>
</table>
{{end}}

<br>
{{if .HasStrategy}}
<table class="list_table">
<caption>Last Strategy ({{formatTime .Strategy.Timestamp}}):</caption>
<tr><td class="title">Summary</td><td>{{.Strategy.Summary}}</td></tr>
<tr><td class="title">Syscall Weights</td><td>{{range .Strategy.SyscallWeights}}{{.Name}} {{printf "%.1f" .Weight}}x | {{end}}{{if not .Strategy.SyscallWeights}}-{{end}}</td></tr>
<tr><td class="title">Seeds</td><td>{{.Strategy.SeedsInjected}} injected ({{.Strategy.SeedsAccepted}} accepted)</td></tr>
<tr><td class="title">Mutation</td><td>{{.Strategy.MutationSummary}}</td></tr>
<tr><td class="title">Focus</td><td>{{range .Strategy.FocusTargets}}{{.CrashTitle}} (p{{.Priority}}) | {{end}}{{if not .Strategy.FocusTargets}}-{{end}}</td></tr>
</table>
{{end}}

{{if .History}}
<br>
<table class="list_table">
<caption>API Call History (last {{len .History}}):</caption>
<thead><tr>
	<th><a onclick="return sortTable(this, 'Time', textSort)" href="#">Time</a></th>
	<th>Type</th>
	<th>Tokens (in/out)</th>
	<th><a onclick="return sortTable(this, 'Cost', floatSort)" href="#">Cost</a></th>
	<th>Result</th>
</tr></thead>
<tbody>
{{range .History}}
<tr>
	<td class="time">{{formatTime .Time}}</td>
	<td>{{.Type}}</td>
	<td class="stat">{{.Input}}/{{.Output}}</td>
	<td class="stat">${{printf "%.3f" .CostUSD}}</td>
	<td>{{if .Success}}{{.ResultSummary}}{{else}}<span style="color:red">{{.Error}}</span>{{end}}</td>
</tr>
{{end}}
</tbody>
</table>
{{end}}

<script>
// Countdown timer.
{{if .NextBatchSec}}
var nextBatch = {{.NextBatchSec}};
setInterval(function() {
	if (nextBatch <= 0) { nextBatch = 3600; }
	nextBatch--;
	var m = Math.floor(nextBatch/60), s = nextBatch%60;
	var el = document.getElementById('countdown');
	if (el) el.textContent = m + 'm ' + (s < 10 ? '0' : '') + s + 's';
}, 1000);
(function() {
	var m = Math.floor(nextBatch/60), s = nextBatch%60;
	var el = document.getElementById('countdown');
	if (el) el.textContent = m + 'm ' + (s < 10 ? '0' : '') + s + 's';
})();
{{end}}

// Trigger AI analysis/strategy via AJAX.
function triggerAI(action) {
	var btn = document.getElementById(action === 'analyze' ? 'analyzeBtn' : 'stratBtn');
	btn.disabled = true;
	btn.textContent = action === 'analyze' ? 'Analyzing...' : 'Strategizing...';
	fetch('/api/ai/' + action, {method: 'POST'}).then(function() {
		pollLog();
	}).catch(function(err) {
		appendLog('ERROR: ' + err);
		btn.disabled = false;
		btn.textContent = action === 'analyze' ? 'Analyze Now' : 'Strategize Now';
	});
}

// Console log polling.
var lastLogLen = 0;
var pollTimer = null;

function appendLog(msg) {
	var c = document.getElementById('console');
	if (!c) return;
	var ts = new Date().toLocaleTimeString('en-GB', {hour12: false});
	c.textContent += '[' + ts + '] ' + msg + '\n';
	c.scrollTop = c.scrollHeight;
}

function pollLog() {
	fetch('/api/ai/log').then(function(r) { return r.json(); }).then(function(data) {
		var c = document.getElementById('console');
		if (!c) return;
		var statusEl = document.getElementById('ai-status');
		if (statusEl) statusEl.textContent = data.running ? 'Running...' : 'Active';
		if (data.lines && data.lines.length > lastLogLen) {
			for (var i = lastLogLen; i < data.lines.length; i++) {
				var entry = data.lines[i];
				var t = new Date(entry.time);
				var ts = t.toLocaleTimeString('en-GB', {hour12: false});
				c.textContent += '[' + ts + '] ' + entry.message + '\n';
			}
			lastLogLen = data.lines.length;
			c.scrollTop = c.scrollHeight;
		}
		if (!data.running) {
			var ab = document.getElementById('analyzeBtn');
			var sb = document.getElementById('stratBtn');
			if (ab) { ab.disabled = false; ab.textContent = 'Analyze Now'; }
			if (sb) { sb.disabled = false; sb.textContent = 'Strategize Now'; }
			if (pollTimer) { clearTimeout(pollTimer); }
			pollTimer = setTimeout(function() { pollTimer = null; }, 5000);
			return;
		}
		setTimeout(pollLog, 1500);
	}).catch(function() {
		setTimeout(pollLog, 3000);
	});
}

// Load initial log lines on page load.
(function() {
	fetch('/api/ai/log').then(function(r) { return r.json(); }).then(function(data) {
		var c = document.getElementById('console');
		if (!c || !data.lines || data.lines.length === 0) return;
		c.textContent = '';
		for (var i = 0; i < data.lines.length; i++) {
			var entry = data.lines[i];
			var t = new Date(entry.time);
			var ts = t.toLocaleTimeString('en-GB', {hour12: false});
			c.textContent += '[' + ts + '] ' + entry.message + '\n';
		}
		lastLogLen = data.lines.length;
		c.scrollTop = c.scrollHeight;
		if (data.running) pollLog();
	});
})();
</script>

{{else}}
<br>
<p>AI triage is disabled. Configure <code>ai_triage</code> in your config file with <code>model</code> and <code>api_key</code> to enable.</p>
{{end}}
