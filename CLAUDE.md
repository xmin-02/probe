# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

PROBE is a Linux kernel fuzzing infrastructure built around Google's [syzkaller](https://github.com/google/syzkaller) — an unsupervised coverage-guided kernel fuzzer. The project automates the full setup: kernel compilation, QEMU VM image creation, BusyBox rootfs building, syzkaller compilation, and fuzzing configuration generation.

Target setup: Linux 6.1.20 kernel on x86_64 (development/testing), fuzzed via QEMU VMs managed by syz-manager. Will switch to latest stable kernel for production use.

## Build Commands

### Full Environment Setup
```bash
# Interactive script — installs deps, builds kernel image, Go, syzkaller, BusyBox rootfs, generates config
sudo ./build_probe.sh
```

### Syzkaller (in syzkaller/ directory)
```bash
cd syzkaller
make              # Build all (host tools + target executor)
make host         # Build syz-manager, syz-repro, syz-mutate, syz-prog2c, syz-db, syz-upgrade
make target       # Build syz-execprog + syz-executor for target OS/arch
make manager      # Build syz-manager only
make executor     # Build syz-executor only (C++)
make clean        # Remove all build artifacts
```

Cross-compilation:
```bash
make HOSTOS=linux HOSTARCH=amd64 TARGETOS=linux TARGETARCH=arm64
```

Debug build (with DWARF/symbols for gdb):
```bash
DEBUG=true make
```

### Testing and Linting (in syzkaller/)
```bash
make test                  # Run all Go tests (short mode, with coverage)
make lint                  # Run golangci-lint with custom syz-linter plugin
make format                # Format Go, C++, and syscall description files
make presubmit             # Full pre-commit validation (build + lint + test + arch checks)
make presubmit_build       # Build + lint + test only
make presubmit_aux         # Generate, format checks, copyright/language/whitespace checks
```

Run a single Go test:
```bash
cd syzkaller
go test ./pkg/cover/...              # Test a specific package
go test -run TestFuncName ./prog/    # Run a specific test function
go test -race ./...                  # Run with race detector
```

### Kernel Build (in linux-6.18.8/)
```bash
cd linux-6.18.8
make -j$(nproc)    # Output: arch/x86/boot/bzImage
```

### BusyBox / RootFS
BusyBox is built statically and packaged into a CPIO rootfs archive. The `build_probe.sh` script handles this, producing `rootfs.cpio` at the project root.

## Running the Fuzzer

```bash
# Generated by build_probe.sh:
cd syzkaller/setup && ./probe.sh

# Or manually:
sudo syzkaller/bin/syz-manager -config syzkaller/setup/probe.cfg
```

The web dashboard is accessible at `http://127.0.0.1:56741` (configurable in probe.cfg).

## Go Environment

The project uses a local Go installation (not system Go):
```bash
export GOROOT=$PWD/goroot
export GOPATH=$PWD/gopath
export PATH=$GOPATH/bin:$GOROOT/bin:$PATH
```

Go module version in syzkaller/go.mod: 1.24.4.

## Architecture

### Syzkaller Components (syzkaller/)

**Runtime components (multi-process architecture):**
- `syz-manager/` — Host-side orchestrator. Starts VMs, coordinates fuzzing, serves web dashboard, manages corpus and crashes.
- `syz-agent/` — Runs inside each VM. Receives programs from manager, dispatches to executor.
- `executor/` — C++ binary (`executor.cc`) running inside VMs. Executes generated syscall sequences directly. Contains generated headers `defs.h` (4MB+) and `syscalls.h`.

**Core libraries:**
- `prog/` — Program representation, generation, mutation, minimization, and serialization. The central data model for syscall sequences.
- `pkg/fuzzer/` — Fuzzing algorithm: coverage-guided feedback loop, hint generation from comparison operands.
- `pkg/cover/` — Code coverage tracking and filtering.
- `pkg/vm/` — Abstract VM interface with backends: `qemu/`, `gce/`, `vmware/`, `bhyve/`, `cuttlefish/`, etc.
- `pkg/report/` — Kernel crash report parsing and deduplication.
- `pkg/manager/` — Manager business logic (separate from the entrypoint).
- `pkg/config/` — Configuration file parsing.

**Syscall description system:**
- `sys/linux/*.txt` — Text-based syscall specifications (the "syzlang").
- `sys/syz-sysgen/` — Code generator that produces Go and C code from `.txt` + `.const` files.
- Generated outputs: `sys/*/gen/*.go`, `executor/defs.h`, `executor/syscalls.h`. Regenerate with `make generate`.

**Other tools:**
- `syz-ci/` — CI system for continuous kernel testing.
- `syz-hub/` — Aggregation hub for distributed fuzzing across multiple managers.
- `dashboard/` — Web application (App Engine) for tracking bugs at scale (powers syzbot).
- `tools/` — Utilities: `syz-repro` (crash reproducer), `syz-prog2c` (convert programs to C), `syz-execprog` (execute a specific program), image creation scripts.

### Key Data Flow

1. `syz-manager` starts QEMU VMs and loads/generates a corpus of syscall programs
2. Programs are sent to `syz-agent` inside each VM
3. `syz-executor` executes syscall sequences and reports coverage back
4. Coverage feedback guides `prog/mutation.go` to produce new program variants
5. Crashes are captured, deduplicated via `pkg/report/`, and minimized
6. Results stored in `workdir/` (corpus, crashes, repros)

### Configuration

Fuzzing config is JSON (see `syzkaller/setup/probe.cfg`). Key fields: `target` (OS/arch), `kernel_obj` (kernel build dir for symbolization), `image` (VM disk image), `sshkey`, `vm` block (count, cpu, mem, kernel bzImage path, cmdline).

## Repository Layout

```
build_probe.sh          # Automated full-stack setup script
Syzkaller_tools.MD      # Documentation for syzkaller/tools/ scripts (Korean)
syzkaller/              # Syzkaller fuzzer (Go + C++)
linux-6.18.8/           # Linux kernel source
busybox-1.37.0/         # BusyBox for minimal rootfs
image/                  # QEMU VM images + SSH keys
rootfs/                 # Extracted rootfs contents
rootfs.cpio             # Packed rootfs archive
goroot/                 # Local Go 1.23.6 installation
gopath/                 # Go workspace (downloaded modules)
```
